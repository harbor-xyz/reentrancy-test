var t=require("isomorphic-unfetch"),e=require("fs"),r=require("path");function n(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var s=/*#__PURE__*/n(t);function o(){return o=Object.assign?Object.assign.bind():function(t){for(var e=1;e<arguments.length;e++){var r=arguments[e];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(t[n]=r[n])}return t},o.apply(this,arguments)}function i(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,u(t,e)}function u(t,e){return u=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},u(t,e)}var c=require("fs"),a=require("project-bin-path"),f=function(t){return new Promise(function(e,r){try{return Promise.resolve(a(process.cwd()).then(function(t){try{return c.existsSync(t+"/harborSDK")?Promise.resolve(t):Promise.resolve((e=require("child_process").exec,new Promise(function(t,r){e("npm bin",function(e,r,n){e&&console.warn(e),t(r||n)})}))).then(function(t){return t.trim()})}catch(t){return Promise.reject(t)}var e})).then(function(n){return(0,require("child_process").exec)(n+"/harborSDK "+t+" --output json",function(t,n,s){t&&(console.error("exec error: "+t),r(JSON.parse(t)));var o=JSON.parse(n);if("error"==o.type){var i=function(t){switch(t){case"AUTH_ERROR":return 401;case"INTERNAL_ERROR":return 500;default:return 400}}(o.status);r({message:o.message,status:i})}else e(o)})})}catch(t){return Promise.reject(t)}})},h=/*#__PURE__*/function(){function t(t){var e,r;this.userKey=void 0,this.projectKey=void 0,this.baseUrl=void 0,this.isAuthenticated=void 0,this.userKey=t.userKey,this.projectKey=t.projectKey,this.baseUrl="https://api-staging.goharbor.com",this.isAuthenticated=!1,(e=this.userKey,r=this.projectKey,f("configure keys --user-key "+e+" --project-key "+r)).then(function(t){return t}).catch(console.error)}return t.prototype.invoke=function(t,e){var r=""+this.baseUrl+t,n=o({},e,{headers:{"Content-Type":"application/json","user-key":this.userKey,"project-key":this.projectKey}});return s.default(r,n).then(function(t){return t.json()}).catch(function(t){throw new Error(t)})},t}();function p(t,e){try{var r=t()}catch(t){return e(t)}return r&&r.then?r.then(void 0,e):r}var m,l=/*#__PURE__*/function(t){function n(){for(var e,r=arguments.length,n=new Array(r),s=0;s<r;s++)n[s]=arguments[s];return(e=t.call.apply(t,[this].concat(n))||this).testnetName=void 0,e}i(n,t);var s=n.prototype;return s.checkHealth=function(){return this.invoke("/health_check")},s.authenticate=function(){try{var t=this;return Promise.resolve(p(function(){return Promise.resolve(t.invoke("/authenticate",{method:"POST",body:JSON.stringify({user_key:t.userKey,project_key:t.projectKey})})).then(function(e){return 200===e.status&&(t.isAuthenticated=!0),Promise.resolve({isAuthenticated:t.isAuthenticated,message:e.message})})},function(t){return Promise.reject({message:t.message,status:401})}))}catch(t){return Promise.reject(t)}},s.testnet=function(t){try{var e=this;return e.isAuthenticated?(e.testnetName=t,Promise.resolve(p(function(){return Promise.resolve(e.invoke("/testnet/"+e.testnetName)).then(function(t){var r;if(200!=t.status)return Promise.reject({message:t.message,status:t.status});var n=null==t||null==(r=t.data)?void 0:r.testnet[0],s=n.id,i=n.testnet_chains,u=n.testnet_off_chain_actors;return 200===t.status?Promise.resolve({id:s,name:n.name,status:n.status,chains:function(){return i.map(function(t){return o({},t,{accounts:e.accounts.bind(e,t.chain),logs:e.logs.bind(e,s,t.chain,0)})})},offChainActors:function(){return u.map(function(t){return o({},t,{ports:function(){return t.ports},logs:e.logs.bind(e,s,t.name,0)})})}}):void 0})},function(t){return Promise.reject({message:t.message,status:400})}))):Promise.reject({message:"Not authenticated",status:401})}catch(t){return Promise.reject(t)}},s.accounts=function(t){try{var e=this;return e.isAuthenticated?Promise.resolve(p(function(){return Promise.resolve(e.invoke("/testnet/"+e.testnetName+"/chain/"+t+"/accounts")).then(function(t){var e=t.data;return Promise.resolve(void 0===e?[]:e)})},function(t){return Promise.reject({message:t.message,status:400})})):Promise.reject({message:"Not authenticated",status:401})}catch(t){return Promise.reject(t)}},s.configure=function(t,e){return f("configure keys --user-key "+t+" --project-key "+e)},s.init=function(){return f("init")},s.logs=function(t,e,r){return f("log --testnet-id "+t+" --name "+e+" --time-period "+r)},s.apply=function(t,n){var s=this;if(!n)return Promise.reject({message:"Testnet name is required",status:400});if("string"==typeof t)return f("apply "+n+" --config "+t).then(function(t){return s.testnet(n)});var o=r.join(process.cwd(),"harbor.config.json");return e.writeFileSync(o,JSON.stringify(t),{flag:"w"}),f("apply "+n+" --config "+o).then(function(t){return s.testnet(n)})},s.clone=function(t,e){var r=this;return t?e?f("clone "+t+" "+e).then(function(t){return r.testnet(e)}):Promise.reject({message:"New Testnet name is required",status:400}):Promise.reject({message:"Existing testnet name and new testnet name is required",status:400})},s.start=function(t,e){var r=this,n="start "+t;return e&&(n="edit "+t+" start "+e),f(""+n).then(function(e){return r.testnet(t)})},s.stop=function(t,e){var r=this,n="kill testnet --name "+t;return e&&(n="edit "+t+" stop "+e),f(""+n).then(function(e){return r.testnet(t)})},s.quickstart=function(t){var e=this;return f("quickstart "+t).then(function(r){return e.testnet(t)})},n}(h),y=/*#__PURE__*/function(t){function e(){return t.apply(this,arguments)||this}return i(e,t),e}(h);m=y,[l].forEach(function(t){Object.getOwnPropertyNames(t.prototype).forEach(function(e){Object.defineProperty(m.prototype,e,Object.getOwnPropertyDescriptor(t.prototype,e)||Object.create(null))})}),module.exports=y;
