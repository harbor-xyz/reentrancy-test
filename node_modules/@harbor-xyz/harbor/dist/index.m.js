import t from"isomorphic-unfetch";import{writeFileSync as e}from"fs";import{join as r}from"path";function n(){return n=Object.assign?Object.assign.bind():function(t){for(var e=1;e<arguments.length;e++){var r=arguments[e];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(t[n]=r[n])}return t},n.apply(this,arguments)}function s(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,o(t,e)}function o(t,e){return o=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},o(t,e)}var i=require("fs"),c=require("project-bin-path"),u=function(t){return new Promise(function(e,r){try{return Promise.resolve(c(process.cwd()).then(function(t){try{return i.existsSync(t+"/harborSDK")?Promise.resolve(t):Promise.resolve((e=require("child_process").exec,new Promise(function(t,r){e("npm bin",function(e,r,n){e&&console.warn(e),t(r||n)})}))).then(function(t){return t.trim()})}catch(t){return Promise.reject(t)}var e})).then(function(n){return(0,require("child_process").exec)(n+"/harborSDK "+t+" --output json",function(t,n,s){t&&(console.error("exec error: "+t),r(JSON.parse(t)));var o=JSON.parse(n);if("error"==o.type){var i=function(t){switch(t){case"AUTH_ERROR":return 401;case"INTERNAL_ERROR":return 500;default:return 400}}(o.status);r({message:o.message,status:i})}else e(o)})})}catch(t){return Promise.reject(t)}})},a=/*#__PURE__*/function(){function e(t){var e,r;this.userKey=void 0,this.projectKey=void 0,this.baseUrl=void 0,this.isAuthenticated=void 0,this.userKey=t.userKey,this.projectKey=t.projectKey,this.baseUrl="https://api-staging.goharbor.com",this.isAuthenticated=!1,(e=this.userKey,r=this.projectKey,u("configure keys --user-key "+e+" --project-key "+r)).then(function(t){return t}).catch(console.error)}return e.prototype.invoke=function(e,r){var s=""+this.baseUrl+e,o=n({},r,{headers:{"Content-Type":"application/json","user-key":this.userKey,"project-key":this.projectKey}});return t(s,o).then(function(t){return t.json()}).catch(function(t){throw new Error(t)})},e}();function h(t,e){try{var r=t()}catch(t){return e(t)}return r&&r.then?r.then(void 0,e):r}var f,p=/*#__PURE__*/function(t){function o(){for(var e,r=arguments.length,n=new Array(r),s=0;s<r;s++)n[s]=arguments[s];return(e=t.call.apply(t,[this].concat(n))||this).testnetName=void 0,e}s(o,t);var i=o.prototype;return i.checkHealth=function(){return this.invoke("/health_check")},i.authenticate=function(){try{var t=this;return Promise.resolve(h(function(){return Promise.resolve(t.invoke("/authenticate",{method:"POST",body:JSON.stringify({user_key:t.userKey,project_key:t.projectKey})})).then(function(e){return 200===e.status&&(t.isAuthenticated=!0),Promise.resolve({isAuthenticated:t.isAuthenticated,message:e.message})})},function(t){return Promise.reject({message:t.message,status:401})}))}catch(t){return Promise.reject(t)}},i.testnet=function(t){try{var e=this;return e.isAuthenticated?(e.testnetName=t,Promise.resolve(h(function(){return Promise.resolve(e.invoke("/testnet/"+e.testnetName)).then(function(t){var r;if(200!=t.status)return Promise.reject({message:t.message,status:t.status});var s=null==t||null==(r=t.data)?void 0:r.testnet[0],o=s.id,i=s.testnet_chains,c=s.testnet_off_chain_actors;return 200===t.status?Promise.resolve({id:o,name:s.name,status:s.status,chains:function(){return i.map(function(t){return n({},t,{accounts:e.accounts.bind(e,t.chain),logs:e.logs.bind(e,o,t.chain,0)})})},offChainActors:function(){return c.map(function(t){return n({},t,{ports:function(){return t.ports},logs:e.logs.bind(e,o,t.name,0)})})}}):void 0})},function(t){return Promise.reject({message:t.message,status:400})}))):Promise.reject({message:"Not authenticated",status:401})}catch(t){return Promise.reject(t)}},i.accounts=function(t){try{var e=this;return e.isAuthenticated?Promise.resolve(h(function(){return Promise.resolve(e.invoke("/testnet/"+e.testnetName+"/chain/"+t+"/accounts")).then(function(t){var e=t.data;return Promise.resolve(void 0===e?[]:e)})},function(t){return Promise.reject({message:t.message,status:400})})):Promise.reject({message:"Not authenticated",status:401})}catch(t){return Promise.reject(t)}},i.configure=function(t,e){return u("configure keys --user-key "+t+" --project-key "+e)},i.init=function(){return u("init")},i.logs=function(t,e,r){return u("log --testnet-id "+t+" --name "+e+" --time-period "+r)},i.apply=function(t,n){var s=this;if(!n)return Promise.reject({message:"Testnet name is required",status:400});if("string"==typeof t)return u("apply "+n+" --config "+t).then(function(t){return s.testnet(n)});var o=r(process.cwd(),"harbor.config.json");return e(o,JSON.stringify(t),{flag:"w"}),u("apply "+n+" --config "+o).then(function(t){return s.testnet(n)})},i.clone=function(t,e){var r=this;return t?e?u("clone "+t+" "+e).then(function(t){return r.testnet(e)}):Promise.reject({message:"New Testnet name is required",status:400}):Promise.reject({message:"Existing testnet name and new testnet name is required",status:400})},i.start=function(t,e){var r=this,n="start "+t;return e&&(n="edit "+t+" start "+e),u(""+n).then(function(e){return r.testnet(t)})},i.stop=function(t,e){var r=this,n="kill testnet --name "+t;return e&&(n="edit "+t+" stop "+e),u(""+n).then(function(e){return r.testnet(t)})},i.quickstart=function(t){var e=this;return u("quickstart "+t).then(function(r){return e.testnet(t)})},o}(a),m=/*#__PURE__*/function(t){function e(){return t.apply(this,arguments)||this}return s(e,t),e}(a);f=m,[p].forEach(function(t){Object.getOwnPropertyNames(t.prototype).forEach(function(e){Object.defineProperty(f.prototype,e,Object.getOwnPropertyDescriptor(t.prototype,e)||Object.create(null))})});export{m as default};
